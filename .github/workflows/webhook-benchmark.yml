name: Webhook Performance Benchmark

on:
  pull_request:
    paths:
      - 'src/webhook/**'
      - 'benchmarks/k6/webhook-load-test.js'
      - '.github/workflows/webhook-benchmark.yml'
  push:
    branches: [main]
    paths:
      - 'src/webhook/**'
  workflow_dispatch:
    inputs:
      baseline_version:
        description: Baseline version to compare
        required: false
        default: webhook-v0.1.0
      regression_threshold:
        description: Regression threshold %
        required: false
        default: "10"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  K6_VERSION: 0.54.0

jobs:
  build-webhook:
    name: Build Webhook Server
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=sha-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "webhook-bench"

      - name: Build webhook server (release mode)
        run: cargo build --release --locked

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: stellar-operator-webhook-${{ steps.version.outputs.version }}
          path: target/release/stellar-operator
          retention-days: 7

  webhook-benchmark:
    name: Webhook Performance Test
    runs-on: ubuntu-latest
    needs: build-webhook
    steps:
      - uses: actions/checkout@v4

      - name: Install k6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/v${{ env.K6_VERSION }}/k6-v${{ env.K6_VERSION }}-linux-amd64.tar.gz | tar xvz
          sudo mv k6-v${{ env.K6_VERSION }}-linux-amd64/k6 /usr/local/bin/
          k6 version

      - name: Install jq and bc
        run: sudo apt-get update && sudo apt-get install -y jq bc

      - name: Download webhook binary
        uses: actions/download-artifact@v4
        with:
          name: stellar-operator-webhook-${{ needs.build-webhook.outputs.version }}
          path: target/release

      - name: Make binary executable
        run: chmod +x target/release/stellar-operator

      - name: Start webhook server
        run: |
          # Start webhook server in background
          ./target/release/stellar-operator webhook \
            --bind 0.0.0.0:8443 \
            --log-level info &
          
          WEBHOOK_PID=$!
          echo "WEBHOOK_PID=$WEBHOOK_PID" >> $GITHUB_ENV
          
          # Wait for webhook to be ready
          echo "Waiting for webhook server to start..."
          for i in {1..30}; do
            if curl -sf http://localhost:8443/health > /dev/null 2>&1; then
              echo "Webhook server is ready!"
              break
            fi
            echo "Attempt $i/30: Webhook not ready yet..."
            sleep 2
          done
          
          # Verify webhook is running
          if ! curl -sf http://localhost:8443/health; then
            echo "ERROR: Webhook server failed to start"
            exit 1
          fi

      - name: Determine baseline file
        id: baseline
        run: |
          BASELINE_VERSION="${{ github.event.inputs.baseline_version || 'webhook-v0.1.0' }}"
          BASELINE_FILE="benchmarks/baselines/${BASELINE_VERSION}.json"
          
          if [[ -f "$BASELINE_FILE" ]]; then
            echo "Using baseline: $BASELINE_FILE"
            echo "baseline_file=$BASELINE_FILE" >> $GITHUB_OUTPUT
            echo "has_baseline=true" >> $GITHUB_OUTPUT
          else
            echo "No baseline found at $BASELINE_FILE"
            echo "has_baseline=false" >> $GITHUB_OUTPUT
          fi

      - name: Run webhook benchmarks
        id: benchmark
        run: |
          mkdir -p results
          
          # Run k6 benchmark
          k6 run \
            --env WEBHOOK_URL=http://localhost:8443 \
            --env VERSION=${{ needs.build-webhook.outputs.version }} \
            --env GIT_SHA=${{ github.sha }} \
            --env RUN_ID=${{ github.run_id }} \
            --env BASELINE_FILE=${{ steps.baseline.outputs.baseline_file }} \
            --out json=results/webhook-benchmark-raw.json \
            benchmarks/k6/webhook-load-test.js
        continue-on-error: true

      - name: Stop webhook server
        if: always()
        run: |
          if [ -n "$WEBHOOK_PID" ]; then
            kill $WEBHOOK_PID || true
          fi

      - name: Check benchmark results
        id: check
        run: |
          if [[ ! -f results/webhook-benchmark.json ]]; then
            echo "ERROR: Benchmark results not found"
            exit 1
          fi
          
          # Extract key metrics
          VAL_P99=$(jq -r '.webhook_metrics.validation_p99' results/webhook-benchmark.json)
          MUT_P99=$(jq -r '.webhook_metrics.mutation_p99' results/webhook-benchmark.json)
          THROUGHPUT=$(jq -r '.webhook_metrics.throughput' results/webhook-benchmark.json)
          ERROR_RATE=$(jq -r '.webhook_metrics.error_rate' results/webhook-benchmark.json)
          
          echo "validation_p99=$VAL_P99" >> $GITHUB_OUTPUT
          echo "mutation_p99=$MUT_P99" >> $GITHUB_OUTPUT
          echo "throughput=$THROUGHPUT" >> $GITHUB_OUTPUT
          echo "error_rate=$ERROR_RATE" >> $GITHUB_OUTPUT
          
          # Check thresholds
          THRESHOLD_PASSED=true
          
          if (( $(echo "$VAL_P99 > 50" | bc -l) )); then
            echo "::error::Validation p99 latency ($VAL_P99 ms) exceeds threshold (50 ms)"
            THRESHOLD_PASSED=false
          fi
          
          if (( $(echo "$MUT_P99 > 50" | bc -l) )); then
            echo "::error::Mutation p99 latency ($MUT_P99 ms) exceeds threshold (50 ms)"
            THRESHOLD_PASSED=false
          fi
          
          if (( $(echo "$THROUGHPUT < 100" | bc -l) )); then
            echo "::error::Throughput ($THROUGHPUT req/s) below minimum (100 req/s)"
            THRESHOLD_PASSED=false
          fi
          
          if (( $(echo "$ERROR_RATE > 0.001" | bc -l) )); then
            echo "::error::Error rate ($ERROR_RATE) exceeds threshold (0.001)"
            THRESHOLD_PASSED=false
          fi
          
          echo "threshold_passed=$THRESHOLD_PASSED" >> $GITHUB_OUTPUT

      - name: Compare with baseline
        if: steps.baseline.outputs.has_baseline == 'true'
        id: regression
        run: |
          BASELINE_FILE="${{ steps.baseline.outputs.baseline_file }}"
          CURRENT_FILE="results/webhook-benchmark.json"
          THRESHOLD="${{ github.event.inputs.regression_threshold || '10' }}"
          
          # Extract baseline metrics
          BASELINE_VAL_P99=$(jq -r '.webhook_metrics.validation_p99' "$BASELINE_FILE")
          BASELINE_MUT_P99=$(jq -r '.webhook_metrics.mutation_p99' "$BASELINE_FILE")
          BASELINE_THROUGHPUT=$(jq -r '.webhook_metrics.throughput' "$BASELINE_FILE")
          
          # Extract current metrics
          CURRENT_VAL_P99=$(jq -r '.webhook_metrics.validation_p99' "$CURRENT_FILE")
          CURRENT_MUT_P99=$(jq -r '.webhook_metrics.mutation_p99' "$CURRENT_FILE")
          CURRENT_THROUGHPUT=$(jq -r '.webhook_metrics.throughput' "$CURRENT_FILE")
          
          # Calculate changes
          VAL_CHANGE=$(echo "scale=2; ($CURRENT_VAL_P99 - $BASELINE_VAL_P99) / $BASELINE_VAL_P99 * 100" | bc)
          MUT_CHANGE=$(echo "scale=2; ($CURRENT_MUT_P99 - $BASELINE_MUT_P99) / $BASELINE_MUT_P99 * 100" | bc)
          THROUGHPUT_CHANGE=$(echo "scale=2; ($CURRENT_THROUGHPUT - $BASELINE_THROUGHPUT) / $BASELINE_THROUGHPUT * 100" | bc)
          
          echo "val_change=$VAL_CHANGE" >> $GITHUB_OUTPUT
          echo "mut_change=$MUT_CHANGE" >> $GITHUB_OUTPUT
          echo "throughput_change=$THROUGHPUT_CHANGE" >> $GITHUB_OUTPUT
          
          # Check for regressions
          REGRESSION_DETECTED=false
          
          if (( $(echo "$VAL_CHANGE > $THRESHOLD" | bc -l) )); then
            echo "::warning::Validation p99 regression: +${VAL_CHANGE}% (threshold: ${THRESHOLD}%)"
            REGRESSION_DETECTED=true
          fi
          
          if (( $(echo "$MUT_CHANGE > $THRESHOLD" | bc -l) )); then
            echo "::warning::Mutation p99 regression: +${MUT_CHANGE}% (threshold: ${THRESHOLD}%)"
            REGRESSION_DETECTED=true
          fi
          
          if (( $(echo "$THROUGHPUT_CHANGE < -$THRESHOLD" | bc -l) )); then
            echo "::warning::Throughput regression: ${THROUGHPUT_CHANGE}% (threshold: -${THRESHOLD}%)"
            REGRESSION_DETECTED=true
          fi
          
          echo "regression_detected=$REGRESSION_DETECTED" >> $GITHUB_OUTPUT
          
          # Create regression report
          cat > results/regression-report.json <<EOF
          {
            "regression_detected": $REGRESSION_DETECTED,
            "threshold_percent": $THRESHOLD,
            "baseline_version": "${{ github.event.inputs.baseline_version || 'webhook-v0.1.0' }}",
            "current_version": "${{ needs.build-webhook.outputs.version }}",
            "metrics": {
              "validation_p99": {
                "baseline": $BASELINE_VAL_P99,
                "current": $CURRENT_VAL_P99,
                "change_percent": $VAL_CHANGE
              },
              "mutation_p99": {
                "baseline": $BASELINE_MUT_P99,
                "current": $CURRENT_MUT_P99,
                "change_percent": $MUT_CHANGE
              },
              "throughput": {
                "baseline": $BASELINE_THROUGHPUT,
                "current": $CURRENT_THROUGHPUT,
                "change_percent": $THROUGHPUT_CHANGE
              }
            }
          }
          EOF

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webhook-benchmark-results-${{ needs.build-webhook.outputs.version }}
          path: |
            results/webhook-benchmark.json
            results/webhook-benchmark-report.md
            results/webhook-benchmark-full.json
            results/regression-report.json
          retention-days: 30

      - name: Create job summary
        if: always()
        run: |
          echo "## ðŸš€ Webhook Performance Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build-webhook.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f results/webhook-benchmark-report.md ]]; then
            cat results/webhook-benchmark-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Benchmark report not generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail on threshold violations
        if: steps.check.outputs.threshold_passed == 'false'
        run: |
          echo "::error::Performance thresholds not met!"
          exit 1

      - name: Fail on regression
        if: steps.regression.outputs.regression_detected == 'true'
        run: |
          echo "::error::Performance regression detected!"
          exit 1

  post-pr-comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    needs: [build-webhook, webhook-benchmark]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Download benchmark results
        uses: actions/download-artifact@v4
        with:
          name: webhook-benchmark-results-${{ needs.build-webhook.outputs.version }}
          path: results/

      - name: Generate PR comment
        run: |
          cat > pr-comment.md <<'EOF'
          ## ðŸš€ Webhook Performance Benchmark Report
          
          **Version:** ${{ needs.build-webhook.outputs.version }}
          **Commit:** ${{ github.sha }}
          
          EOF
          
          if [[ -f results/webhook-benchmark.json ]]; then
            VAL_P99=$(jq -r '.webhook_metrics.validation_p99' results/webhook-benchmark.json)
            VAL_P95=$(jq -r '.webhook_metrics.validation_p95' results/webhook-benchmark.json)
            VAL_AVG=$(jq -r '.webhook_metrics.validation_avg' results/webhook-benchmark.json)
            
            MUT_P99=$(jq -r '.webhook_metrics.mutation_p99' results/webhook-benchmark.json)
            MUT_P95=$(jq -r '.webhook_metrics.mutation_p95' results/webhook-benchmark.json)
            MUT_AVG=$(jq -r '.webhook_metrics.mutation_avg' results/webhook-benchmark.json)
            
            THROUGHPUT=$(jq -r '.webhook_metrics.throughput' results/webhook-benchmark.json)
            ERROR_RATE=$(jq -r '.webhook_metrics.error_rate' results/webhook-benchmark.json)
            TOTAL_REQUESTS=$(jq -r '.webhook_metrics.total_requests' results/webhook-benchmark.json)
            
            cat >> pr-comment.md <<EOF
          ### ðŸ“Š Performance Metrics
          
          | Webhook | Avg | p95 | p99 | Threshold |
          |---------|-----|-----|-----|-----------|
          | Validation | ${VAL_AVG} ms | ${VAL_P95} ms | ${VAL_P99} ms | < 50 ms |
          | Mutation | ${MUT_AVG} ms | ${MUT_P95} ms | ${MUT_P99} ms | < 50 ms |
          
          | Metric | Value | Threshold |
          |--------|-------|-----------|
          | Throughput | ${THROUGHPUT} req/s | > 100 req/s |
          | Error Rate | $(echo "$ERROR_RATE * 100" | bc)% | < 0.1% |
          | Total Requests | ${TOTAL_REQUESTS} | - |
          
          EOF
          fi
          
          if [[ -f results/regression-report.json ]]; then
            REGRESSION=$(jq -r '.regression_detected' results/regression-report.json)
            
            if [[ "$REGRESSION" == "true" ]]; then
              cat >> pr-comment.md <<EOF
          ### âš ï¸ Regression Detected
          
          Performance regression detected compared to baseline.
          
          <details>
          <summary>View Details</summary>
          
          \`\`\`json
          $(jq '.metrics' results/regression-report.json)
          \`\`\`
          
          </details>
          EOF
            else
              cat >> pr-comment.md <<EOF
          ### âœ… No Regression Detected
          
          Performance is within acceptable thresholds compared to baseline.
          EOF
            fi
          fi
          
          cat >> pr-comment.md <<EOF
          
          ---
          *Benchmarked with k6 on GitHub Actions*
          EOF

      - name: Post comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: pr-comment.md
