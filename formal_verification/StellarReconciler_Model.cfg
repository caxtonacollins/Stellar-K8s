---- MODULE StellarReconciler_Model ----

(* TLC Model Checker Configuration *)
(* 
   This configuration file specifies parameters for running TLC on the
   StellarReconciler specification.
   
   Usage:
     tlc -config StellarReconciler_Model.cfg StellarReconciler.tla
*)

(* ============================================================================ *)
(* VARIABLE DECLARATIONS *)
(* ============================================================================ *)

VARIABLES
  nodes,
  globalClock

(* ============================================================================ *)
(* MODEL PARAMETERS *)
(* ============================================================================ *)

(* Node identifiers - can be customized *)
CONSTANT
  NODES = {"n1", "n2"}

(* Maximum reconciliation steps - prevents infinite loops in model *)
CONSTANT
  MAX_RECONCILE_STEPS = 15

(* ============================================================================ *)
(* SPECIFICATION *)
(* ============================================================================ *)

(* Use the main specification from StellarReconciler.tla *)
SPECIFICATION Spec

(* ============================================================================ *)
(* INVARIANTS TO CHECK *)
(* ============================================================================ *)

(* These invariants must hold at every step *)

INVARIANT TypeInvariant
  \* Type correctness

INVARIANT InvalidSpecNeverRunning
  \* Safety: Invalid specs cannot reach Running state

INVARIANT RunningInvariant
  \* Safety: Running nodes must be healthy with valid spec

INVARIANT NoResourceLeak
  \* Safety: Resources only exist in managed states

INVARIANT CleanupCompleteness
  \* Safety: Cleanup removes all artifacts

INVARIANT ServiceMeshCleanupOrder
  \* Safety: Service mesh cleaned before main resources

INVARIANT NoRaceConditions
  \* Safety: No concurrent creation and deletion

INVARIANT FinalizerCompleteness
  \* Safety: Finalizer only present during deletion

(* ============================================================================ *)
(* TEMPORAL PROPERTIES TO CHECK *)
(* ============================================================================ *)

(* These liveness properties require fairness assumptions *)

PROPERTY ValidSpecEventuallyRunning
  \* Liveness: Valid specs reach Running state

PROPERTY RunningEventuallyStable
  \* Liveness: Running states are stable

PROPERTY CleanupEventuallyCompletes
  \* Liveness: Cleanup finishes and nodes delete

(* ============================================================================ *)
(* SYMMETRY REDUCTION *)
(* ============================================================================ *)

(* Optional: Reduce state space by exploiting symmetry *)
(* Uncomment if TLC state space becomes too large *)

(* 
SYMMETRY
  Permutations(NODES)
*)

(* ============================================================================ *)
(* MODEL CHECKING PARAMETERS *)
(* ============================================================================ *)

(* 
   DEPTH
   Sets the maximum transition count before model checker stops.
   Higher values find longer execution paths.
   Default: 100000
   Recommendation: 1000000 for thorough checking
*)

(* 
   CHECKPOINT
   Frequency of progress file writes (for long running checks).
   Set to number of states before checkpoint.
   Default: 0 (no checkpointing)
   Recommendation: 100000 for > 1M state checks
*)

(* ============================================================================ *)
(* LIVENESS ASSUMPTIONS *)
(* ============================================================================ *)

(* For liveness properties, weak fairness is assumed *)
(* Run with: tlc -deadlock -fair StellarReconciler.tla *)

(* ============================================================================ *)
(* SUGGESTED RUN CONFIGURATIONS *)
(* ============================================================================ *)

(*
  CONFIG 1: Quick Safety Check (2-3 minutes)
  ──────────────────────────────────────────
  Command: tlc -deadlock StellarReconciler.tla
  Checks: All safety properties only
  State Limit: Default (~10M)
  
  Output: "No error found" = All invariants hold
  
  
  CONFIG 2: Full Safety + Liveness (5-10 minutes)
  ───────────────────────────────────────────────
  Command: tlc -deadlock -fair StellarReconciler.tla
  Checks: All safety + all liveness properties
  Fairness: Weak fairness assumed
  
  Output: "No error found" = All properties proven
  
  
  CONFIG 3: Small Cluster (1 node) - Baseline (< 1 minute)
  ──────────────────────────────────────────────────────
  Command: tlc -deadlock -modelValue 'NODES = {n1}' StellarReconciler.tla
  Use Case: Quick verification of basic paths
  
  
  CONFIG 4: Multi-Node Analysis (2-3 nodes) (10-30 minutes)
  ──────────────────────────────────────────────────────
  Command: tlc -deadlock -modelValue 'NODES = {n1, n2, n3}' StellarReconciler.tla
  Use Case: Discover concurrent operation interactions
  
  
  CONFIG 5: Extended Run with Symmetry (cloud/HPC only)
  ────────────────────────────────────────────────────
  Command: tlc -deadlock -fair -dfid StellarReconciler.tla
  Use Case: Depth-first iterative deepening for very large spaces
  Requirements: 64+ GB RAM, distributed TLC
*)

(* ============================================================================ *)
(* DEBUGGING A COUNTEREXAMPLE *)
(* ============================================================================ *)

(*
  If TLC finds an error (counterexample):
  
  1. TLC outputs the execution trace to 'MC.out' file
  
  2. Analyze the trace:
     - Each line shows state transition
     - Identify where invariant is violated
     - Examime the state just before violation
  
  3. Questions to ask:
     a) Is this behavior possible in real system?
        YES: Code has a bug - fix in reconciler.rs
        NO:  Model assumption is wrong - refine model
     
     b) Can this happen due to system properties?
        YES: Relax the property or add guards
        NO:  Find and fix code bug
  
  4. Fix and re-verify:
     - Modify either StellarReconciler.tla or source code
     - Re-run tlc with same configuration
     - Verify no error found
  
  EXAMPLE COUNTEREXAMPLE ANALYSIS:
  ──────────────────────────────
  Error: INVARIANT InvalidSpecNeverRunning violated
  
  Trace excerpt:
    State: n1.spec_valid = "invalid", n1.state = "SpecInvalid"
    Action: SpecValidationFails(n1)
    State: n1.spec_valid = "invalid", n1.state = "SpecInvalid"
    Action: StartResourceCreation(n1)  ← ERROR: shouldn't be allowed!
    State: n1.spec_valid = "invalid", n1.state = "CreatingResources"
  
  Analysis: StartResourceCreation is missing guard that checks spec_valid != "invalid"
  Fix: Add guard to StartResourceCreation action
  
*)

(* ============================================================================ *)
(* EXPECTED RESULTS *)
(* ============================================================================ *)

(*
  Successful model checking output:
  
  >> Model Checking completed. No error has been found.
  >> Statistics: diameter 125, total states 4521897, distinct states 2518739
  >> root: 4511 actions, 2518739 states, checked
  
  Interpretation:
  - diameter = longest path in state graph (125 transitions)
  - states = total state visits during search
  - distinct states = unique states explored
  
  Good signs:
  ✓ "No error found" = All properties hold
  ✓ diameter < MAX_RECONCILE_STEPS + buffer
  ✓ distinct states << total states (good state deduplication)
  
  Bad sign:
  ✗ "ERROR: ... INVARIANT violated" = Property doesn't hold
  ✗ "Deadlock reached" = System can get stuck
*)

(* ============================================================================ *)
(* PERFORMANCE TUNING *)
(* ============================================================================ *)

(*
  If model checking is slow:
  
  1. Reduce NODES set
     FROM: {n1, n2, n3}
     TO:   {n1, n2}
     Effect: Reduces state space exponentially
  
  2. Reduce MAX_RECONCILE_STEPS
     FROM: 20
     TO:   10
     Effect: Prevents long execution paths
     Risk: Might miss bugs that require many steps
  
  3. Enable symmetry reduction (uncomment SYMMETRY section)
     Effect: Exploits permutation symmetry to reduce states
  
  4. Use dfid (depth-first iterative deepening)
     Command: tlc -dfid StellarReconciler.tla
     Effect: Memory-efficient for large state spaces
  
  5. Run on multi-core system or distributed TLC
     Command: tlc -workers N
     N = number of cores (e.g., 8, 16)
*)

(* ============================================================================ *)
(* RUNNING MODEL CHECKER *)
(* ============================================================================ *)

(*
  INSTALLATION (if needed):
  
  1. Download from: https://lamport.azurewebsites.net/tla/tools.html
  2. Extract to /opt/tlp or ~/tools/tlp
  3. Add to PATH: export PATH=$PATH:/opt/tla/bin
  4. Verify: which tlc
  
  RUNNING CHECKS:
  
  # Safety only (fast)
  $ cd formal_verification
  $ tlc -deadlock StellarReconciler.tla
  
  # With liveness (needs fairness)
  $ tlc -deadlock -fair StellarReconciler.tla
  
  # Custom node count
  $ tlc -deadlock -modelValue 'NODES = {n1, n2}' StellarReconciler.tla
  
  # With this config file
  $ tlc -config StellarReconciler_Model.cfg StellarReconciler.tla
  
  MONITORING LONG RUNS:
  
  # In another terminal, watch progress
  $ watch -n 5 'tail -5 MC.out'
  
  # Check memory usage
  $ top -p $(pgrep -f 'java.*tlc')
*)

(* ============================================================================ *)
(* DOCUMENTATION *)
(* ============================================================================ *)

(*
  For more information, see:
  
  - README.md
    Overview of verification, getting started
  
  - FORMAL_VERIFICATION.md
    Complete property definitions and proofs
  
  - EDGE_CASES.md
    12 specific edge cases and how model covers them
  
  - StellarReconciler.tla
    Main specification with all actions and properties
  
  - StellarReconcilerChecks.tla
    Extended checks and model-specific properties
*)

====
